AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Queue Stack

Parameters:
  stage:
    Description: "Stage"
    Type: String
  backupRegion:
    Description: "Backup Region"
    Type: String
  coreLayer:
    Description: "Core Library Layer"
    Type: String
  securityGroup:
    Description: "Lambda VPC security group"
    Type: String
    Default: ""
  vpcSubnetIds:
    Description: "Lambda VPC Subnets"
    Type: CommaDelimitedList
    Default: ""
  enableVPC:
    Description: "Is VPC enabled (true|false)"
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
  dbTableName:
    Description: "Table Name"
    Type: String
    Default: "DBTable"

Conditions:
  isVPCEnabled: !Equals [ !Ref enableVPC, 'true' ]

Globals:
  Function:
    MemorySize: 256
    Timeout: 30
    Runtime: python3.9
    Environment:
      Variables:
        "stage": !Ref "stage"
        "region": !Ref AWS::Region
    Layers:
      - !Ref coreLayer
    VpcConfig: !If
      - isVPCEnabled
      - SecurityGroupIds:
          - !Ref securityGroup
        SubnetIds: !Ref vpcSubnetIds
      - !Ref AWS::NoValue

Resources:

  AccessLogQueueHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./async/log_event/app_access_log
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AmazonSSMReadOnlyAccess
        - SQSPollerPolicy:
            QueueName: !GetAtt AccessLogQueue.QueueName
      Handler: app_access_logger.log_access_event
      Events:
        AccessLogEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AccessLogQueue.Arn
            BatchSize: 10

  AccessLogQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60

  AccessLogQueueUrlParameter:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !If [ isVPCEnabled, "ACCESS_LOG_QUEUE_URL_VPC", "ACCESS_LOG_QUEUE_URL_NO_VPC" ]
      Type: "String"
      Value: !GetAtt AccessLogQueue.QueueUrl

  ErrorLogQueueHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./async/log_event/app_error_log
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AmazonSSMReadOnlyAccess
        - SQSPollerPolicy:
            QueueName: !GetAtt ErrorLogQueue.QueueName
      Handler: app_error_logger.log_error_event
      Events:
        ErrorLogEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ErrorLogQueue.Arn
            BatchSize: 10

  ErrorLogQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60

  ErrorLogQueueUrlParameter:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !If [ isVPCEnabled, "ERROR_LOG_QUEUE_URL_VPC", "ERROR_LOG_QUEUE_URL_NO_VPC" ]
      Type: "String"
      Value: !GetAtt ErrorLogQueue.QueueUrl

  AuthEventQueueHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./async/auth_event
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AmazonSSMReadOnlyAccess
        - AmazonCognitoPowerUser
        - AmazonSQSFullAccess
        - SQSPollerPolicy:
            QueueName: !GetAtt AuthEventQueue.QueueName
      Handler: auth_event_handler.handle_auth_event
      Events:
        ErrorLogEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AuthEventQueue.Arn
            BatchSize: 10

  AuthEventQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60

  AuthEventQueueUrlParameter:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !If [ isVPCEnabled, "AUTH_EVENT_QUEUE_URL_VPC", "AUTH_EVENT_QUEUE_URL_NO_VPC" ]
      Type: "String"
      Value: !GetAtt AuthEventQueue.QueueUrl

Outputs:
  AccessLogQueueName:
    Value: !GetAtt AccessLogQueue.QueueName
  ErrorLogQueueName:
    Value: !GetAtt ErrorLogQueue.QueueName
  AuthEventQueueName:
    Value: !GetAtt AuthEventQueue.QueueName
  AccessLogQueueUrl:
    Value: !GetAtt AccessLogQueue.QueueUrl
  ErrorLogQueueUrl:
    Value: !GetAtt ErrorLogQueue.QueueUrl
  AuthEventQueueUrl:
    Value: !GetAtt AuthEventQueue.QueueUrl
