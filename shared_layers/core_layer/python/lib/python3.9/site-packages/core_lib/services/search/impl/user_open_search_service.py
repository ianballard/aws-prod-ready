from core_lib.services.search.impl.open_search_service import (
    create_index,
    upsert,
    COMMON_SETTINGS,
    AUTOCOMPLETE_MAPPING,
    search,
)

USER_INDEX_NAME = "user"


def create_user_index():
    index_name = USER_INDEX_NAME
    index_body = {
        "settings": COMMON_SETTINGS,
        "mappings": {
            "properties": {
                "username": AUTOCOMPLETE_MAPPING,
                "profile": {"type": "text"},
                "email": AUTOCOMPLETE_MAPPING,
                "first_name": AUTOCOMPLETE_MAPPING,
                "last_name": AUTOCOMPLETE_MAPPING,
            }
        },
    }
    return create_index(index_name=index_name, index_body=index_body)


def upsert_user_doc(user: dict):
    _id = user.get("profile")
    doc = {
        "username": user["username"].lower(),
        "profile": user["profile"].lower(),
        "email": user["email"].lower(),
        "first_name": user["first_name"].lower(),
        "last_name": user["last_name"].lower(),
    }
    return upsert(index_name=USER_INDEX_NAME, _id=_id, doc=doc)


def search_users(search_str: str):
    query = {
        "suggest": {
            "username_suggestion": {
                "prefix": search_str,
                "completion": {"field": "username"},
            },
            "first_name_suggestion": {
                "prefix": search_str,
                "completion": {"field": "first_name"},
            },
            "last_name_suggestion": {
                "prefix": search_str,
                "completion": {"field": "last_name"},
            },
            "email_suggestion": {
                "prefix": search_str,
                "completion": {"field": "email"},
            },
        }
    }

    response = search(index_name=USER_INDEX_NAME, query=query)

    all_suggestions = []
    for suggestion in response.get("suggest", {}).values():
        options = next(iter(suggestion)).get("options")
        if options:
            all_suggestions.extend(options)

    unique_suggestions = {}

    for option in all_suggestions:
        _id = option["_id"]
        if _id not in unique_suggestions:
            user = option["_source"]
            unique_suggestions[_id] = {
                "profile": user["profile"],
                "username": user["username"],
            }

    return list(unique_suggestions.values())
