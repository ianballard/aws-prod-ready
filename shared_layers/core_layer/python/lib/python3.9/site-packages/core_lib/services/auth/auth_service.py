import functools
import os

from core_lib.services.auth.impl import cognito_service
from core_lib.services.queue.queue_service import (
    send_message_to_queue,
    get_auth_event_queue_url,
)
from core_lib.utils.args_util import get_non_null_kwargs

AUTH_SERVICE_IMPL = cognito_service


def get_user_pool_id():
    return AUTH_SERVICE_IMPL.get_user_pool_id()


def get_audience():
    return AUTH_SERVICE_IMPL.get_user_pool_client()


def get_known_public_keys():
    return AUTH_SERVICE_IMPL.get_known_public_keys()


def replicate_auth_event(func):
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        response = func(*args, **kwargs)

        message = {
            "event_type": func.__name__,
            "args": get_non_null_kwargs(**kwargs),
        }
        region = os.getenv("BACKUP_REGION")
        send_message_to_queue(
            message, region=region, queue_url=get_auth_event_queue_url(region=region)
        )

        return response

    return wrapper


@replicate_auth_event
def sign_up(username: str, email: str, password: str, first_name: str, last_name: str):
    return AUTH_SERVICE_IMPL.sign_up(
        username=username,
        email=email,
        password=password,
        first_name=first_name,
        last_name=last_name,
    )


@replicate_auth_event
def confirm_sign_up(username: str, code: str):
    return AUTH_SERVICE_IMPL.confirm_sign_up(username=username, code=code)


@replicate_auth_event
def respond_to_new_password_auth_challenge(username: str, password: str, session: str):
    return AUTH_SERVICE_IMPL.respond_to_new_password_auth_challenge(
        username=username, password=password, session=session
    )


def initiate_user_password_auth(username: str, password: str):
    return AUTH_SERVICE_IMPL.initiate_user_password_auth(
        username=username, password=password
    )


@replicate_auth_event
def admin_create_user(
    username: str, email: str, password: str, first_name: str, last_name: str
):
    return AUTH_SERVICE_IMPL.admin_create_user(
        username=username,
        email=email,
        password=password,
        first_name=first_name,
        last_name=last_name,
    )
