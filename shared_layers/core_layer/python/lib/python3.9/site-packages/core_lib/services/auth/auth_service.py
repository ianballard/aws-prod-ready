import functools
import os

from core_lib.services.auth.impl import cognito_service
from core_lib.services.queue.queue_service import (
    send_message_to_queue,
    get_auth_event_queue_url,
)
from core_lib.utils.args_util import get_non_null_kwargs

AUTH_SERVICE_IMPL = cognito_service


def get_user_pool_id():
    return AUTH_SERVICE_IMPL.get_user_pool_id()


def get_audience():
    return AUTH_SERVICE_IMPL.get_user_pool_client()


def get_known_public_keys():
    return AUTH_SERVICE_IMPL.get_known_public_keys()


def replicate_auth_event(func):
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        response = func(*args, **kwargs)

        message = {
            "event_type": func.__name__,
            "args": get_non_null_kwargs(**kwargs),
        }
        region = os.getenv("BACKUP_REGION")
        send_message_to_queue(
            message, region=region, queue_url=get_auth_event_queue_url(region=region)
        )

        return response

    return wrapper


@replicate_auth_event
def replicated_sign_up(
    profile: str,
    username: str,
    email: str,
    password: str,
    first_name: str,
    last_name: str,
):
    return sign_up(
        profile=profile,
        username=username,
        email=email,
        password=password,
        first_name=first_name,
        last_name=last_name,
    )


@replicate_auth_event
def replicated_confirm_sign_up(username: str, code: str):
    return confirm_sign_up(username=username, code=code)


def sign_up(
    profile: str,
    username: str,
    email: str,
    password: str,
    first_name: str,
    last_name: str,
):
    return AUTH_SERVICE_IMPL.sign_up(
        profile=profile,
        username=username,
        email=email,
        password=password,
        first_name=first_name,
        last_name=last_name,
    )


def confirm_sign_up(username: str, code: str):
    return AUTH_SERVICE_IMPL.confirm_sign_up(username=username, code=code)


def initiate_user_password_auth(username: str, password: str):
    return AUTH_SERVICE_IMPL.initiate_user_password_auth(
        username=username, password=password
    )


def admin_create_user(
    profile: str,
    username: str,
    email: str,
    password: str,
    first_name: str,
    last_name: str,
    suppress_message: bool = False,
    is_password_permanent: bool = False,
):
    return AUTH_SERVICE_IMPL.admin_create_user(
        profile=profile,
        username=username,
        email=email,
        password=password,
        first_name=first_name,
        last_name=last_name,
        suppress_message=suppress_message,
        is_password_permanent=is_password_permanent,
    )


def admin_disable_user(username: str):
    return AUTH_SERVICE_IMPL.admin_disable_user(
        username=username,
    )
