import json

from core_lib.utils.date_time_util import get_current_utc_datetime_iso
from core_lib.utils.thread_util import safe_get_thread_attribute


def api():
    def decorator(func):
        def wrapper(event):
            api_request = ApiRequest(event)

            message = {
                "utc_datetime_iso": get_current_utc_datetime_iso(),
                "log_type": "APP_ACCESS_LOG",
                "event_type": "API_REQUEST",
                "lambda_event": safe_get_thread_attribute("event"),
                "request_headers": api_request.headers,
                "request_body": api_request.body,
                "request_path_parameters": api_request.path_parameters,
            }
            print(message)

            return func(api_request=api_request)

        return wrapper

    return decorator


class ApiRequest:
    def __init__(self, event: dict):
        self.headers = event.get("headers", {})
        self.path_parameters = event.get("pathParameters", {})
        self.body = (
            json.loads(event.get("body", {}))
            if self.headers.get("Content-Type", "application/json")
            == "application/json"
            and event.get("body") is not None
            else event.get("body")
        )
        self.query_parameters = event.get("queryStringParameters", {})
